
http {
    upstream appserver {
        #Docker container name is "app"
        server app:3000
    }

    server {
        # uses HTTPS and listens on port 8080 (inside conatiner)
        listen 8080 ssl;

        # add your domain name here (e.g., example.com, localhost, etc)
        server_name example.com;

        # SSL Configuration: SSL/TSL certs generated during multi build-stage Dockerfile
        ssl_certificate /etc/nginx/ssl/nginx.crt;
        ssl_certificate_key /etc/nginx/ssl/nginx.key;

        # Serve Angular app or static content
        location / {
            try_files $uri $uri/ /index.html;
        }

        # Proxy requests for API routes (or routes that fetch from the database)
        location /api/ {
            # Internel redirect: Forward only `/api/` routes to the app server
            proxy_pass http:appserver;  
            # keey aline http version 1.1 
            proxy_http_version 1.1;
            # Doesn't modify anything passes same header to the app server
            proxy_set_header Host $host; 
            # Forward the real IP address to the app server
            proxy_set_header X-Real-IP $remote_addr;
            # adds both client and server IP address to X-Forwarded-For header to track full request chain
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            # Tells appser if client is used http or https
            proxy_set_header X-Forwarded-Proto $scheme;
        }
    }

}

